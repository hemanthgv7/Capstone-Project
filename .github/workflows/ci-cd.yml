name: CI-CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout Source Code
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # Set up Docker
      # -----------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------
      # Build Backend Image
      # -----------------------------
      - name: Build Backend Docker Image
        run: |
          docker build -t backend-api:ci ./backend

      # -----------------------------
      # Build Frontend Image
      # -----------------------------
      - name: Build Frontend Docker Image
        run: |
          docker build -t frontend-ui:ci ./frontend

      # -----------------------------
      # Run Backend Container Test
      # -----------------------------
      - name: Test Backend Health Endpoint
        run: |
          docker run -d -p 5000:5000 --name backend_test backend-api:ci
          sleep 10
          curl -f http://localhost:5000/health
          docker rm -f backend_test

      # -----------------------------
      # (Optional) Security Scan
      # -----------------------------
      - name: Trivy Scan Backend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: backend-api:ci
          severity: HIGH,CRITICAL
          exit-code: 0
